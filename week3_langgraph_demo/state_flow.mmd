flowchart TD
  %% ===== LangGraph 节点与边（可直接对照实现） =====

  %% Entry
  A["ingest_node (写入本轮 HumanMessage / 截断窗口 / 打时间戳)"] --> B["router_node (小模型判意图: qa / tool / rag / chitchat / unknown)"]

  %% Routing
  B -- tool --> C["tool_agent_node (LLM 选择并调用工具 或 create_tool_calling_agent)"]
  B -- rag --> D["rag_retrieve_node (检索 TopK / 重排 / 过滤)"]
  B -- qa --> E["qa_generate_node (不依赖文档的直接回答)"]
  B -- chitchat --> F["chitchat_node (闲聊回复)"]
  B -- unknown --> G["clarify_node (澄清提问 / 补齐关键信息)"]

  %% Tool branch
  C --> H["final_assemble_node (汇总 messages / tool_results / retrieved_docs)"]

  %% RAG branch
  D --> I["rag_generate_node (结合 retrieved_docs 生成回答)"]
  I --> H

  %% QA / Chitchat branch
  E --> H
  F --> H

  %% 可选 HITL（人工确认）
  H -- 需要人工确认? --> J{HITL?}
  J -- 是 --> K["hitl_node (中断 / 审批 / 修改草稿)"] --> H
  J -- 否 --> L["output_node (渲染到终端 / 网页 / 记录日志)"]

  %% Clarify 出口
  G --> L

  %% End
  L --> M[End]